
UPDATE public.sec_filing_attachment SET contract_type_id = 1 WHERE contract_type = 'purchase and sale agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 2 WHERE contract_type = 'energy assets';
UPDATE public.sec_filing_attachment SET contract_type_id = 3 WHERE contract_type = 'gas purchase contract';
UPDATE public.sec_filing_attachment SET contract_type_id = 4 WHERE contract_type = 'crude oil supply agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 5 WHERE contract_type = 'gas supply agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 6 WHERE contract_type = 'oil purchase and deliver agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 7 WHERE contract_type = 'mixed assets';
UPDATE public.sec_filing_attachment SET contract_type_id = 8 WHERE contract_type = 'membership interest purchase agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 9 WHERE contract_type = 'stock purchase agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 10 WHERE contract_type = 'unit purchase agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 11 WHERE contract_type = 'project agreements';
UPDATE public.sec_filing_attachment SET contract_type_id = 12 WHERE contract_type = 'facilities agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 13 WHERE contract_type = 'undefined';
UPDATE public.sec_filing_attachment SET contract_type_id = 14 WHERE contract_type = 'operating agreements';
UPDATE public.sec_filing_attachment SET contract_type_id = 15 WHERE contract_type = 'omnibus operating agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 16 WHERE contract_type = 'international operating agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 17 WHERE contract_type = 'joint operating agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 18 WHERE contract_type = 'joint venture agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 19 WHERE contract_type = 'partnership agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 20 WHERE contract_type = 'area of mutual interest agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 21 WHERE contract_type = 'royalty agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 22 WHERE contract_type = 'production payment royalty agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 23 WHERE contract_type = 'conveyance of net profits interest';
UPDATE public.sec_filing_attachment SET contract_type_id = 24 WHERE contract_type = 'participation and farmout agreements';
UPDATE public.sec_filing_attachment SET contract_type_id = 25 WHERE contract_type = 'participation agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 26 WHERE contract_type = 'farm-out agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 27 WHERE contract_type = 'asset exploration agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 28 WHERE contract_type = 'production participation plan payment agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 29 WHERE contract_type = 'exploration agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 30 WHERE contract_type = 'drilling participation agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 31 WHERE contract_type = 'lease agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 32 WHERE contract_type = 'petroleum and natural gas lease';
UPDATE public.sec_filing_attachment SET contract_type_id = 33 WHERE contract_type = 'equipment lease agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 34 WHERE contract_type = 'mineral lease';
UPDATE public.sec_filing_attachment SET contract_type_id = 35 WHERE contract_type = 'oil sands lease';
UPDATE public.sec_filing_attachment SET contract_type_id = 36 WHERE contract_type = 'production system lease agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 37 WHERE contract_type = 'power purchase agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 38 WHERE contract_type = 'swap agreements';
UPDATE public.sec_filing_attachment SET contract_type_id = 39 WHERE contract_type = 'crude oil swap agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 40 WHERE contract_type = 'natural gas swap agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 41 WHERE contract_type = 'assignment agreements and deeds';
UPDATE public.sec_filing_attachment SET contract_type_id = 42 WHERE contract_type = 'NEW_assignment_of_royalty_interest';
UPDATE public.sec_filing_attachment SET contract_type_id = 43 WHERE contract_type = 'assignment of overriding royalty interest';
UPDATE public.sec_filing_attachment SET contract_type_id = 44 WHERE contract_type = 'assignment agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 45 WHERE contract_type = 'assignment and transfer agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 46 WHERE contract_type = 'assignment, conveyance and bill of sale';
UPDATE public.sec_filing_attachment SET contract_type_id = 47 WHERE contract_type = 'deed of guaranty and indemnity';
UPDATE public.sec_filing_attachment SET contract_type_id = 48 WHERE contract_type = 'service contracts';
UPDATE public.sec_filing_attachment SET contract_type_id = 49 WHERE contract_type = 'service agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 50 WHERE contract_type = 'contract operating agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 51 WHERE contract_type = 'personnel services agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 52 WHERE contract_type = 'administrative services agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 53 WHERE contract_type = 'consulting services agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 54 WHERE contract_type = 'management agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 55 WHERE contract_type = 'support agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 56 WHERE contract_type = 'midstream contracts';
UPDATE public.sec_filing_attachment SET contract_type_id = 57 WHERE contract_type = 'gathering agreements';
UPDATE public.sec_filing_attachment SET contract_type_id = 58 WHERE contract_type = 'gas gathering agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 59 WHERE contract_type = 'throughput agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 60 WHERE contract_type = 'separation agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 61 WHERE contract_type = 'natural gas treating & condensate handling agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 62 WHERE contract_type = 'conveyance of gas processing rights';
UPDATE public.sec_filing_attachment SET contract_type_id = 63 WHERE contract_type = 'gas transportation and sales agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 64 WHERE contract_type = 'pipeline construction and operating agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 65 WHERE contract_type = 'IP agreements';
UPDATE public.sec_filing_attachment SET contract_type_id = 66 WHERE contract_type = 'license agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 67 WHERE contract_type = 'subsurface mineral resources license';
UPDATE public.sec_filing_attachment SET contract_type_id = 68 WHERE contract_type = 'technology license agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 69 WHERE contract_type = 'contribution agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 70 WHERE contract_type = 'undefined';
UPDATE public.sec_filing_attachment SET contract_type_id = 71 WHERE contract_type = 'credit agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 72 WHERE contract_type = 'deed of trust';
UPDATE public.sec_filing_attachment SET contract_type_id = 73 WHERE contract_type = 'tax agreements';
UPDATE public.sec_filing_attachment SET contract_type_id = 74 WHERE contract_type = 'tax sharing agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 75 WHERE contract_type = 'option agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 76 WHERE contract_type = 'hard mineral agreements';
UPDATE public.sec_filing_attachment SET contract_type_id = 77 WHERE contract_type = 'coal purchase contract';
UPDATE public.sec_filing_attachment SET contract_type_id = 78 WHERE contract_type = 'misc';
UPDATE public.sec_filing_attachment SET contract_type_id = 79 WHERE contract_type = 'bill of sale';
UPDATE public.sec_filing_attachment SET contract_type_id = 80 WHERE contract_type = 'shipyard contract';
UPDATE public.sec_filing_attachment SET contract_type_id = 81 WHERE contract_type = 'production sharing contract';
UPDATE public.sec_filing_attachment SET contract_type_id = 82 WHERE contract_type = 'master offset agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 83 WHERE contract_type = 'employment agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 84 WHERE contract_type = 'non-competition agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 85 WHERE contract_type = 'indemnification agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 86 WHERE contract_type = 'change of control agreementnotes/debt';
UPDATE public.sec_filing_attachment SET contract_type_id = 87 WHERE contract_type = 'drilling purchase agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 88 WHERE contract_type = 'merger agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 89 WHERE contract_type = 'option and joint venture agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 90 WHERE contract_type = 'press release';
UPDATE public.sec_filing_attachment SET contract_type_id = 91 WHERE contract_type = 'production and marketing agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 92 WHERE contract_type = 'shareholder agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 93 WHERE contract_type = 'turnkey drilling contract';
UPDATE public.sec_filing_attachment SET contract_type_id = 94 WHERE contract_type = 'securities';
UPDATE public.sec_filing_attachment SET contract_type_id = 95 WHERE contract_type = 'contribution, conveyance and assumption agreement';
UPDATE public.sec_filing_attachment SET contract_type_id = 96 WHERE contract_type = 'mortgage, assignment of production';

CREATE OR REPLACE VIEW "public"."sec_contract" AS 
 SELECT attachment.accession_number,
    attachment.sequence,
    company.name AS company_name,
    company.cik AS company_cik,
    company.geo AS company_geo,
    company.sic AS company_sic,
    company.sic_name AS company_sic_name,
    filing.filing_type,
    filing.header AS filing_header,
    filing.filing_date,
    attachment.description,
    attachment.attachment_type,
    attachment.tsv_search_text,
    (0.0)::real AS relevance,
    attachment.contract_type,
    attachment.uid,
    attachment.contract_type_id
   FROM ((sec_company company
     JOIN sec_filing filing ON ((filing.cik = company.cik)))
     JOIN sec_filing_attachment attachment ON ((attachment.accession_number = filing.accession_number)));

DROP FUNCTION public.sec_search;
CREATE OR REPLACE FUNCTION public.sec_search(search text DEFAULT NULL::text, filing_date_lt date DEFAULT NULL::date, filing_date_gt date DEFAULT NULL::date, description_includes text DEFAULT NULL::text, description_excludes text DEFAULT NULL::text, company_name_includes text DEFAULT NULL::text, company_name_excludes text DEFAULT NULL::text, contract_type_id_eq integer[] DEFAULT NULL::integer[], company_cik_eq text[] DEFAULT NULL::text[])
 RETURNS SETOF sec_contract
 LANGUAGE sql
 STABLE
AS $function$
SELECT
  a.accession_number,
  a.sequence,
  a.company_name,
  a.company_cik,
  a.company_geo,
  a.company_sic,
  a.company_sic_name,
  a.filing_type,
  a.filing_header,
  a.filing_date,
  a.description,
  a.attachment_type,
  a.tsv_search_text,
  ts_rank(tsv_search_text, q) AS relevance,
  a.contract_type,
  a.uid,
  a.contract_type_id
FROM
  sec_contract AS a,
  plainto_tsquery(search) AS q
WHERE
  (
    search is null
    or search = ''
    or q @@ tsv_search_text
  )
  and (
    filing_date_lt is null
    or filing_date <= filing_date_lt
  )
  and (
    filing_date_gt is null
    or filing_date >= filing_date_gt
  )
  and (
    description_includes is null
    or description ilike concat('%', trim(description_includes), '%')
  )
  and (
    description_excludes is null
    or description not ilike concat('%', trim(description_excludes), '%')
  )
  and (
    company_name_includes is null
    or company_name ilike concat('%', trim(company_name_includes), '%')
  )
  and (
    description_excludes is null
    or company_name not ilike concat('%', trim(description_excludes), '%')
  )
  and (
    contract_type_id_eq is null
    or a.contract_type_id = ANY(contract_type_id_eq)
  )
  and (
    company_cik_eq is null
    or a.company_cik = ANY(company_cik_eq)
  )
ORDER BY
  relevance desc
$function$;

DROP FUNCTION "public"."sec_search";
DROP VIEW "public"."sec_contract";

CREATE OR REPLACE VIEW "public"."sec_contract" AS 
 SELECT attachment.accession_number,
    attachment.sequence,
    company.name AS company_name,
    company.cik AS company_cik,
    company.geo AS company_geo,
    company.sic AS company_sic,
    company.sic_name AS company_sic_name,
    filing.filing_type,
    filing.header AS filing_header,
    filing.filing_date,
    attachment.description,
    attachment.attachment_type,
    attachment.tsv_search_text,
    (0.0)::real AS relevance,
    attachment.contract_type_id,
    attachment.uid
   FROM ((sec_company company
     JOIN sec_filing filing ON ((filing.cik = company.cik)))
     JOIN sec_filing_attachment attachment ON ((attachment.accession_number = filing.accession_number)));

CREATE OR REPLACE FUNCTION public.sec_search(search text DEFAULT NULL::text, filing_date_lt date DEFAULT NULL::date, filing_date_gt date DEFAULT NULL::date, description_includes text DEFAULT NULL::text, description_excludes text DEFAULT NULL::text, company_name_includes text DEFAULT NULL::text, company_name_excludes text DEFAULT NULL::text, contract_type_id_eq integer[] DEFAULT NULL::integer[], company_cik_eq text[] DEFAULT NULL::text[])
 RETURNS SETOF sec_contract
 LANGUAGE sql
 STABLE
AS $function$
SELECT
  a.accession_number,
  a.sequence,
  a.company_name,
  a.company_cik,
  a.company_geo,
  a.company_sic,
  a.company_sic_name,
  a.filing_type,
  a.filing_header,
  a.filing_date,
  a.description,
  a.attachment_type,
  a.tsv_search_text,
  ts_rank(tsv_search_text, q) AS relevance,
  a.contract_type_id,
  a.uid
FROM
  sec_contract AS a,
  plainto_tsquery(search) AS q
WHERE
  (
    search is null
    or search = ''
    or q @@ tsv_search_text
  )
  and (
    filing_date_lt is null
    or filing_date <= filing_date_lt
  )
  and (
    filing_date_gt is null
    or filing_date >= filing_date_gt
  )
  and (
    description_includes is null
    or description ilike concat('%', trim(description_includes), '%')
  )
  and (
    description_excludes is null
    or description not ilike concat('%', trim(description_excludes), '%')
  )
  and (
    company_name_includes is null
    or company_name ilike concat('%', trim(company_name_includes), '%')
  )
  and (
    description_excludes is null
    or company_name not ilike concat('%', trim(description_excludes), '%')
  )
  and (
    contract_type_id_eq is null
    or a.contract_type_id = ANY(contract_type_id_eq)
  )
  and (
    company_cik_eq is null
    or a.company_cik = ANY(company_cik_eq)
  )
ORDER BY
  relevance desc
$function$;

DROP INDEX IF EXISTS "public"."contract_type_idx";

alter table "public"."sec_filing_attachment" drop column "contract_type" cascade;

DROP FUNCTION public.sec_search;
CREATE OR REPLACE FUNCTION public.sec_search(search text DEFAULT NULL::text, filing_date_lt date DEFAULT NULL::date, filing_date_gt date DEFAULT NULL::date, description_includes text DEFAULT NULL::text, description_excludes text DEFAULT NULL::text, company_name_includes text DEFAULT NULL::text, company_name_excludes text DEFAULT NULL::text, contract_type_id_eq text[] DEFAULT NULL::text[], company_cik_eq text[] DEFAULT NULL::text[])
 RETURNS SETOF sec_contract
 LANGUAGE sql
 STABLE
AS $function$
SELECT
  a.accession_number,
  a.sequence,
  a.company_name,
  a.company_cik,
  a.company_geo,
  a.company_sic,
  a.company_sic_name,
  a.filing_type,
  a.filing_header,
  a.filing_date,
  a.description,
  a.attachment_type,
  a.tsv_search_text,
  ts_rank(tsv_search_text, q) AS relevance,
  a.contract_type_id,
  a.uid
FROM
  sec_contract AS a,
  plainto_tsquery(search) AS q
WHERE
  (
    search is null
    or search = ''
    or q @@ tsv_search_text
  )
  and (
    filing_date_lt is null
    or filing_date <= filing_date_lt
  )
  and (
    filing_date_gt is null
    or filing_date >= filing_date_gt
  )
  and (
    description_includes is null
    or description ilike concat('%', trim(description_includes), '%')
  )
  and (
    description_excludes is null
    or description not ilike concat('%', trim(description_excludes), '%')
  )
  and (
    company_name_includes is null
    or company_name ilike concat('%', trim(company_name_includes), '%')
  )
  and (
    description_excludes is null
    or company_name not ilike concat('%', trim(description_excludes), '%')
  )
  and (
    contract_type_id_eq is null
    or a.contract_type_id::text = ANY(contract_type_id_eq)
  )
  and (
    company_cik_eq is null
    or a.company_cik = ANY(company_cik_eq)
  )
ORDER BY
  relevance desc
$function$;
