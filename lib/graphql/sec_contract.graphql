fragment SearchResult on sec_contract {
  uid
  accession_number
  sequence
  company_name
  company_cik
  company_sic_name
  # company_geo
  filing_type
  # filing_metadata
  filing_date
  description
  attachment_type
  contract_type
}

# description: { _ilike: "%purchase and sale%", _nilike: "%amendment%" }
query SearchSECContracts(
  $search: String!
  $minDate: date
  $maxDate: date
  $limit: Int = 20
  $offset: Int = 0
  $uidsOnly: Boolean = false
  $contractType: String
) {
  sec_search_aggregate(
    args: {
      search: $search
      filing_date_gt: $minDate
      filing_date_lt: $maxDate
      contract_type_eq: $contractType
    }
  ) {
    nodes @include(if: $uidsOnly) {
      uid
    }
    aggregate {
      filing_count: count(columns: accession_number, distinct: true)
      company_count: count(columns: company_cik, distinct: true)
      count
    }
  }
  sec_search(
    args: {
      search: $search
      filing_date_gt: $minDate
      filing_date_lt: $maxDate
      contract_type_eq: $contractType
    }
    order_by: { relevance: desc }
    limit: $limit
    offset: $offset
  ) @skip(if: $uidsOnly) {
    ...SearchResult
  }
}

fragment SECContract on sec_filing_attachment {
  sequence
  sec_filing {
    accession_number
    filing_date
    filing_type
    sec_company {
      name
      sic
      sic_name
    }
  }
  attachment_type
  description
  contents
}

query GetSECContract($accession_number: String!, $sequence: Int!) {
  sec_filing_attachment_by_pk(
    accession_number: $accession_number
    sequence: $sequence
  ) {
    ...SECContract
  }
}

fragment ContractTypeFragment on sec_filing_attachment {
  contract_type
}

query GetContractTypes {
  sec_filing_attachment(
    distinct_on: [contract_type]
    # discard null
    where: { contract_type: { _like: "%" } }
  ) {
    ...ContractTypeFragment
  }
}
